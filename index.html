<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wiki Downhill - Ultimate</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --primary: #4A90E2;
            --success: #00b894;
            --danger: #d63031;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --font-main: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-main);
            overflow-x: hidden;
        }

        .game-container {
            width: 100%;
            max-width: 480px;
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            padding: 30px 20px;
            box-sizing: border-box;
            margin: 20px;
            position: relative;
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
        }

        header { text-align: center; margin-bottom: 25px; }
        h1 { margin: 0; font-size: 1.8rem; letter-spacing: -0.5px; background: linear-gradient(45deg, #4A90E2, #8e44ad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { font-size: 0.85rem; color: var(--text-sub); margin-top: 5px; }

        .stats-row {
            display: flex;
            justify-content: space-between;
            background: #f1f2f6;
            padding: 10px 20px;
            border-radius: 16px;
            margin-bottom: 25px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .stat-item span { color: var(--primary); font-size: 1.1rem; margin-left: 5px; }

        .target-display {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        .target-label { font-size: 0.75rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        .target-number { 
            font-size: 3.5rem; 
            font-weight: 800; 
            line-height: 1.1; 
            margin: 10px 0; 
            font-variant-numeric: tabular-nums; 
            transition: color 0.3s;
        }
        .target-word { 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: var(--primary);
            padding: 5px 15px;
            background: rgba(74, 144, 226, 0.1);
            border-radius: 20px;
            display: inline-block;
        }

        .input-area { position: relative; margin-bottom: 15px; }
        input[type="text"] {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            border: 2px solid #dfe6e9;
            border-radius: 16px;
            box-sizing: border-box;
            outline: none;
            transition: all 0.3s;
            appearance: none;
        }
        input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.15); }
        
        button {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            background: var(--primary);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: transform 0.1s, background 0.3s;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
            -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .btn-restart { background: var(--text-main); margin-top: 10px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        .message-box { min-height: 24px; text-align: center; margin: 15px 0; font-size: 0.95rem; font-weight: bold; }
        .error-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; color: var(--danger); }
        .success-pop { animation: pop 0.3s ease; color: var(--success); }

        .history-list {
            margin-top: 20px;
            border-top: 2px solid #f1f2f6;
            padding-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f9f9f9;
            font-size: 0.9rem;
            animation: slideDown 0.3s ease forwards;
        }
        .history-word { font-weight: bold; }
        .history-val { color: var(--text-sub); font-family: monospace; font-size: 1rem; }

        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .game-over .target-number { color: var(--danger); text-decoration: line-through; }
    </style>
</head>
<body>

<div class="game-container" id="container">
    <header>
        <h1>üìâ Wiki Downhill</h1>
        <div class="subtitle">Áõ¥Ëøë30Êó•Èñì„ÅÆÈñ≤Ë¶ßÊï∞„Çí‰∏ã„ÅíÁ∂ö„Åë„Çç</div>
    </header>

    <div class="stats-row">
        <div class="stat-item">SCORE: <span id="score">0</span></div>
        <div class="stat-item">BEST: <span id="best-score">0</span></div>
    </div>

    <div class="target-display">
        <div class="target-label">CURRENT TARGET (LESS THAN)</div>
        <div class="target-number" id="target-value">‚àû</div>
        <div class="target-word" id="target-word">START</div>
    </div>

    <div class="input-area">
        <input type="text" id="keyword" list="suggestions" placeholder="ÂçòË™û„ÇíÂÖ•Âäõ (‰æã: Êó•Êú¨)" autocomplete="off">
        <datalist id="suggestions"></datalist>
    </div>

    <button id="submit-btn">ÂãùË≤†„Åô„Çã</button>
    
    <div class="message-box" id="msg"></div>

    <button id="restart-btn" class="btn-restart">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶</button>

    <div class="history-list" id="history"></div>
</div>

<script>
    // --- Áä∂ÊÖãÁÆ°ÁêÜ ---
    const STATE = {
        lastValue: Infinity,
        score: 0,
        bestScore: localStorage.getItem('wiki_downhill_best') || 0,
        history: []
    };

    // --- DOMË¶ÅÁ¥† ---
    const UI = {
        container: document.getElementById('container'),
        input: document.getElementById('keyword'),
        submitBtn: document.getElementById('submit-btn'),
        restartBtn: document.getElementById('restart-btn'),
        targetValue: document.getElementById('target-value'),
        targetWord: document.getElementById('target-word'),
        score: document.getElementById('score'),
        bestScore: document.getElementById('best-score'),
        msg: document.getElementById('msg'),
        history: document.getElementById('history'),
        datalist: document.getElementById('suggestions')
    };

    // ÂàùÊúüË°®Á§∫
    UI.bestScore.textContent = STATE.bestScore;

    // --- Wikipedia API (Á≤æÂ∫¶ÈáçË¶ñ) ---
    async function fetchSuggestions(query) {
        if (!query) return;
        try {
            const url = `https://ja.wikipedia.org/w/api.php?action=opensearch&format=json&origin=*&search=${encodeURIComponent(query)}&limit=5`;
            const res = await fetch(url);
            const data = await res.json();
            return data[1] || [];
        } catch(e) { return []; }
    }

    async function fetchTotalViews(title) {
        const endDate = new Date();
        endDate.setDate(endDate.getDate() - 2); 
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 32); 

        const formatDate = d => d.toISOString().slice(0, 10).replace(/-/g, '');
        const url = `https://wikimedia.org/api/rest_v1/metrics/pageviews/per-article/ja.wikipedia/all-access/all-agents/${encodeURIComponent(title)}/daily/${formatDate(startDate)}/${formatDate(endDate)}`;

        try {
            const res = await fetch(url);
            if (res.status === 404) return null;
            const data = await res.json();
            if (!data.items || data.items.length === 0) return null;
            return data.items.reduce((acc, curr) => acc + curr.views, 0);
        } catch (e) {
            return null;
        }
    }

    // --- ÊºîÂá∫Á≥ª„É≠„Ç∏„ÉÉ„ÇØ ---
    function animateValue(element, start, end, duration) {
        if (start === "‚àû") start = end * 1.5; 
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const currentVal = Math.floor(progress * (end - start) + start);
            element.textContent = currentVal.toLocaleString();
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                element.textContent = end.toLocaleString();
            }
        };
        window.requestAnimationFrame(step);
    }

    // --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ ---
    let debounceTimer;
    UI.input.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            const val = e.target.value.trim();
            if(val.length > 0) {
                const list = await fetchSuggestions(val);
                UI.datalist.innerHTML = '';
                list.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item;
                    UI.datalist.appendChild(opt);
                });
            }
        }, 300);
    });

    async function handleTurn() {
        const word = UI.input.value.trim();
        if (!word) return;

        UI.submitBtn.disabled = true;
        UI.submitBtn.textContent = "„Éá„Éº„ÇøÂèñÂæó‰∏≠...";
        UI.input.disabled = true;
        UI.msg.textContent = "";
        UI.msg.className = "message-box";

        const views = await fetchTotalViews(word);

        if (views === null) {
            UI.msg.textContent = `‚ö†Ô∏è „Äå${word}„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÊ≠£Á¢∫„Å™Ë®ò‰∫ãÂêç„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
            UI.msg.classList.add("error-shake");
            resetInputState();
            return;
        }

        if (views < STATE.lastValue) {
            successTurn(word, views);
        } else {
            gameOver(word, views);
        }
    }

    function successTurn(word, views) {
        STATE.score++;
        UI.score.textContent = STATE.score;

        const prev = STATE.lastValue === Infinity ? views * 2 : STATE.lastValue;
        animateValue(UI.targetValue, prev, views, 800);
        
        STATE.lastValue = views;
        UI.targetWord.textContent = word;

        UI.msg.textContent = "‚úÖ „Éä„Ç§„ÇπÔºÅÊ¨°„Å∏ÈÄ≤„ÇÇ„ÅÜ";
        UI.msg.classList.add("success-pop");

        addHistory(word, views, true);
        
        UI.input.value = "";
        resetInputState();
        UI.submitBtn.textContent = "ÂãùË≤†„Åô„Çã";
    }

    function gameOver(word, views) {
        UI.container.classList.add("game-over");
        UI.targetValue.textContent = STATE.lastValue.toLocaleString();
        
        UI.msg.innerHTML = `üíÄ <b>„Éâ„Éú„É≥ÔºÅ</b><br>„Äå${word}„Äç„ÅØ ${views.toLocaleString()} views„Åß„Åó„Åü„ÄÇ<br>(${STATE.lastValue.toLocaleString()}„Çà„ÇäÂ∞è„Åï„ÅÑÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô)`;
        UI.msg.className = "message-box error-shake";

        addHistory(word, views, false);

        if (STATE.score > STATE.bestScore) {
            STATE.bestScore = STATE.score;
            localStorage.setItem('wiki_downhill_best', STATE.score);
            UI.bestScore.textContent = STATE.score;
            UI.msg.innerHTML += "<br>üèÜ <b>NEW RECORD!</b>";
        }

        UI.submitBtn.style.display = "none";
        UI.input.style.display = "none";
        UI.restartBtn.style.display = "block";
    }

    function addHistory(word, views, isSuccess) {
        const div = document.createElement("div");
        div.className = "history-item";
        div.style.color = isSuccess ? "inherit" : "var(--danger)";
        div.innerHTML = `
            <span class="history-word">${word}</span>
            <span class="history-val">${views.toLocaleString()}</span>
        `;
        UI.history.prepend(div);
    }

    function resetInputState() {
        UI.submitBtn.disabled = false;
        UI.submitBtn.textContent = "ÂãùË≤†„Åô„Çã";
        UI.input.disabled = false;
        UI.input.focus();
    }

    function restartGame() {
        STATE.lastValue = Infinity;
        STATE.score = 0;
        UI.score.textContent = "0";
        UI.targetValue.textContent = "‚àû";
        UI.targetWord.textContent = "START";
        UI.msg.textContent = "";
        UI.history.innerHTML = "";
        UI.input.value = "";
        
        UI.container.classList.remove("game-over");
        UI.submitBtn.style.display = "block";
        UI.input.style.display = "block";
        UI.restartBtn.style.display = "none";
        
        resetInputState();
    }

    UI.submitBtn.addEventListener('click', handleTurn);
    UI.restartBtn.addEventListener('click', restartGame);
    UI.input.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') handleTurn();
    });
    
    UI.input.focus();

</script>
</body>
</html>
